# 高级电机控制程序

**基于小米电机官方功能码表格的完整控制系统**

## 🎯 项目特点

- ✅ **完整功能码支持**：基于官方功能码表格，支持所有参数
- ✅ **实时状态监控**：温度、电压、故障、位置、速度全面监控
- ✅ **精确PID调节**：在线调节所有PID参数
- ✅ **安全保护机制**：自动安全监控和紧急停止
- ✅ **参数持久化**：配置自动保存到EEPROM
- ✅ **故障诊断**：详细的故障代码分析和处理

## 📋 功能码映射

### 🔧 配置参数
```cpp
0x200a // CAN_ID - 本节点ID (1-127)
0x200b // CAN_MASTER - 主机ID (0-127)
0x200c // CAN_TIMEOUT - 超时阈值
0x200d // motorOverTemp - 保护温度值
0x200f // GearRatio - 传动比
```

### 🎮 控制参数
```cpp
0x2012 // cur_kp - 电流KP (0-200)
0x2013 // cur_ki - 电流KI (0-200)
0x2014 // spd_kp - 速度KP (0-200)
0x2015 // spd_ki - 速度KI (0-200)
0x2016 // loc_kp - 位置KP (0-200)
```

### ⚡ 限制参数
```cpp
0x2007 // limit_torque - 转矩限制 (0-12 Nm)
0x2018 // limit_spd - 速度限制 (0-200 rad/s)
0x2019 // limit_cur - 电流限制 (0-23 A)
```

### 📊 状态参数
```cpp
0x3014 // rotation - 圈数
0x3015 // modPos - 电机角度(未计圈)
0x3016 // mechPos - 负载位置(计圈) ★ 主用
0x3017 // mechVel - 负载速度 ★ 主用
0x3006 // motorTemp - 电机温度
0x300c // vBus - 母线电压
0x3022 // faultSta - 故障状态
0x3023 // warnSta - 警告状态
```

## 🎮 控制命令

### 基本控制
```bash
pos 1.57          # 设置位置1.57弧度(90度)
spd 5.0           # 设置速度5.0rad/s
stop              # 紧急停止
clear             # 清除故障
```

### 状态查询
```bash
status            # 显示完整状态信息
params            # 显示所有可调参数
info              # 读取设备信息
```

### 参数调节
```bash
# 直接设置功能码
set 0x2016 30.0   # 设置位置KP=30.0
get 0x3016        # 读取当前位置

# 快捷命令（在tune模式内）
tune              # 进入PID调节模式
  kp 25.0         # 设置位置KP
  kd 5.0          # 设置速度KP
  ki 0.02         # 设置速度KI
  test            # 执行阶跃响应测试
  save            # 保存参数
  exit            # 退出调节
```

### 安全功能
```bash
monitor           # 启动连续安全监控
emergency         # 立即紧急停止
```

## 🔧 高级功能

### 1. 实时状态监控
```bash
status
```
输出示例：
```
=== 电机完整状态 ===
电机ID: 1
控制模式: 位置

--- 运动状态 ---
位置: 1.571 rad (90.0°)
速度: 0.015 rad/s (1.4 RPM)
圈数: 0
电流: 2.35 A

--- 系统状态 ---
电机温度: 33.3°C
母线电压: 24.20 V
故障代码: 0x00000000 ✓
警告代码: 0x00000000 ✓
==================
```

### 2. PID在线调节
```bash
tune              # 进入调节模式
kp 25.0           # 调整位置响应速度
kd 10.0           # 调整阻尼
ki 0.05           # 减少稳态误差
test              # 阶跃响应测试
save              # 保存到EEPROM
```

### 3. 故障诊断
```bash
status            # 查看故障代码
clear             # 清除故障状态
```

### 4. 参数批量读取
```bash
params            # 显示所有参数
```

## 🛡️ 安全保护

### 自动安全监控
- **温度保护**：超过85°C自动停机
- **电压保护**：超出18-32V范围警告
- **位置保护**：超出±12弧度警告
- **故障保护**：检测到故障立即停机

### 安全阈值
```cpp
温度阈值: 85°C
电压范围: 18-32V
位置范围: -12到12弧度
```

## 📊 典型应用场景

### 场景1：机器人关节调试
```bash
# 1. 查看当前状态
status

# 2. 调节PID参数
tune
kp 40.0           # 提高响应速度
test              # 测试响应
save              # 保存参数

# 3. 位置控制
pos 1.57          # 转90度
pos 0             # 回零
```

### 场景2：生产线监控
```bash
# 1. 连续监控
monitor           # 启动安全监控

# 2. 定期检查
status            # 每小时检查状态
params            # 检查参数是否正常

# 3. 故障处理
clear             # 清除偶发故障
```

### 场景3：性能优化
```bash
# 1. 阶跃响应测试
tune
test              # 默认阶跃测试

# 2. 参数优化
kp 35.0           # 调整位置KP
kd 8.0            # 调整速度KP
ki 0.03           # 调整速度KI
test              # 再次测试

# 3. 保存最优参数
save
```

## 🚀 快速开始

### 1. 硬件连接
- ESP32 + CAN模块
- 小米电机 + 电源(12-24V)
- CAN总线连接

### 2. 软件配置
- 上传 `advanced_motor_control.ino`
- 打开串口监视器(115200)
- 观察初始化信息

### 3. 基本测试
```bash
status            # 确认电机正常
pos 1.57          # 测试位置控制
pos 0             # 回到原位
```

## 🔍 故障排除

### 电机无响应？
1. 检查CAN连接和波特率(1Mbps)
2. 确认电机电源(12-24V)
3. 检查电机ID设置

### PID参数不当？
1. 使用 `tune` 模式调节
2. 从小参数开始，逐步增加
3. 每次调节后 `test` 测试响应

### 温度过高？
1. 检查负载是否过重
2. 降低运行速度
3. 改善散热条件

### 参数设置失败？
1. 确认功能码正确
2. 检查参数范围
3. 重新发送命令

## 💡 专业技巧

### 1. PID调节顺序
```bash
# 推荐调节顺序
1. 先调位置KP (kp) - 决定响应速度
2. 再调速度KP (kd) - 决定阻尼
3. 最后调速度KI (ki) - 消除稳态误差
```

### 2. 参数记忆
```bash
# 所有重要参数会自动保存
- PID参数
- 限制参数
- ID配置
- 重启后自动加载
```

### 3. 安全操作
```bash
# 重要操作前检查状态
status            # 确认无故障
monitor           # 启动监控
# 再进行控制操作
```

### 4. 调试技巧
```bash
# 阶跃响应测试要点
- 响应时间：通常0.5-2秒
- 超调量：小于10%
- 稳态误差：小于1%
```

---

**总结**：这个高级控制程序提供了小米电机的完整控制能力，通过功能码可以直接访问所有电机参数，实现专业级的电机控制和应用开发。