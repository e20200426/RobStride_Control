# 小米电机ESP32控制程序

基于ESP32开发板的小米电机CAN总线控制程序，支持多种控制模式和实时状态监控。

## 📋 项目概述

本项目实现了通过ESP32控制小米电机的完整解决方案，包括：
- CAN总线通信（1Mbps）
- 多种控制模式（速度、位置、电流、运控）
- 实时状态监控
- 串口调试接口

## 🔧 硬件要求

### 主要硬件
- **ESP32开发板**
- **CAN模块**（支持1Mbps波特率）
- **小米电机**（CAN ID=1）
- **电源**（12-24V DC）

### 接线说明

#### ESP32 ↔ CAN模块
```
ESP32      CAN模块
GPIO5  ←→ TX
GPIO4  ←→ RX
3.3V   ←→ VCC
GND    ←→ GND
```

#### CAN模块 ↔ 小米电机
```
CAN模块  小米电机
CAN_H   ←→ CAN_H
CAN_L   ←→ CAN_L
12-24V  ←→ 电源正
GND     ←→ 电源负
```

## 💻 软件环境

### Arduino IDE设置
1. **安装ESP32开发板支持**
   ```arduino
   文件 → 首选项 → 附加开发板管理器网址
   添加：https://dl.espressif.com/dl/package_esp32_index.json
   ```

2. **安装开发板**
   ```
   工具 → 开发板 → 开发板管理器
   搜索：ESP32
   安装：Espressif Systems ESP32
   ```

3. **选择开发板**
   ```
   工具 → 开发板 → ESP32 Arduino → ESP32 Dev Module
   ```

### 必需库安装
在Arduino库管理器中安装以下库：
- **ESP32-TWAI-CAN** （CAN通信库）

## 🚀 快速开始

### 1. 下载项目
```bash
# 所有文件位于 /home/w0x7ce/Downloads/test_lz/mi_arduino/
```

### 2. 配置Arduino IDE
1. 打开 `mi_motor_control.ino`
2. 选择正确的开发板：ESP32S3 Dev Module
3. 选择正确的串口

### 3. 上传程序
1. 连接ESP32S3到电脑
2. 点击上传按钮
3. 等待上传完成

### 4. 监控运行状态
1. 打开串口监视器（波特率115200）
2. 观察初始化过程
3. 查看实时电机数据

## 📱 程序功能

### 自动控制模式
程序启动后会自动执行以下控制序列：
- 每5秒切换一次速度
- 速度序列：0 → 2 → -2 → 1 → -1 → 0 rad/s

### 串口命令控制
通过串口监视器输入命令：

| 命令 | 功能 | 示例 |
|------|------|------|
| `stop` | 停止电机 | `stop` |
| `enable` | 使能电机 | `enable` |
| `disable` | 禁用电机 | `disable` |
| `speed X` | 设置速度X rad/s | `speed 3.5` |
| `pos X` | 位置模式，设置位置X rad | `pos 1.57` |
| `speed_mode` | 切换到速度模式 | `speed_mode` |
| `zero` | 设置零点 | `zero` |
| `help` | 显示帮助 | `help` |

### 实时数据监控
程序会持续输出以下数据：
```
M1: 主站ID,电机ID,错误状态,HALL错误,磁编码错误,温度错误,电流错误,电压错误,模式状态,角度,速度,扭矩,温度
```

## 🎯 控制模式详解

### 1. 速度模式 (SPEED_MODE)
- 设置目标角速度：-30 到 +30 rad/s
- 适用场景：连续旋转控制

### 2. 位置模式 (POS_MODE)
- 设置目标角度：-12.5 到 +12.5 rad
- 可设置最大速度限制
- 适用场景：精确定位控制

### 3. 电流模式 (CUR_MODE)
- 设置目标电流：-23 到 +23 A
- 适用场景：力控制

### 4. 运控模式 (CTRL_MODE)
- 同时控制扭矩、位置、速度、PD参数
- 适用场景：复杂运动控制

## 📊 数据格式说明

### CAN帧结构
- **29位扩展帧ID**：通信类型(5bit) + 数据区2(16bit) + 目标地址(8bit)
- **8字节数据区**：控制参数或反馈数据

### 反馈数据解析
```cpp
// 角度: (-4π ~ 4π) rad
cur_angle = raw_angle * 0.000383501049 - 4*PI

// 速度: (-30 ~ 30) rad/s
cur_speed = raw_speed * 0.000915541314 - 30

// 扭矩: (-12 ~ 12) Nm
cur_torque = raw_torque * 0.000366216526 - 12

// 温度: 摄氏度
cur_temp = raw_temp / 10.0
```

## ⚠️ 安全注意事项

### 硬件安全
1. **电源电压**：确保12-24V DC，不要超过电机额定电压
2. **CAN总线**：正确连接CAN_H和CAN_L，避免反接
3. **接地**：确保良好的接地连接
4. **电流**：注意最大电流限制，避免过载

### 软件安全
1. **参数范围**：严格按照参数范围设置，避免损坏电机
2. **使能顺序**：遵循初始化顺序，先配置再使能
3. **错误监控**：注意错误状态，及时处理异常
4. **温度监控**：监控电机温度，避免过热

### 操作安全
1. **机械固定**：确保电机牢固安装，避免转动时移动
2. **运动范围**：确保运动范围内无障碍物
3. **紧急停止**：准备紧急停止方案
4. **逐步测试**：从小参数开始测试，确认正常后再增加

## 🔧 参数配置

### 电机参数
```cpp
#define MOTER_1_ID      1        // 电机ID
#define MASTER_ID       0        // 主机ID
#define P_MIN           -12.5f   // 位置最小值
#define P_MAX           12.5f    // 位置最大值
#define V_MIN           -30.0f   // 速度最小值
#define V_MAX           30.0f    // 速度最大值
#define T_MIN           -12.0f   // 扭矩最小值
#define T_MAX           12.0f    // 扭矩最大值
```

### CAN参数
```cpp
#define CAN_TX          5        // CAN发送引脚
#define CAN_RX          4        // CAN接收引脚
// 波特率：1Mbps（在代码中固定）
```

## 🐛 故障排除

### 常见问题

#### 1. CAN通信失败
- 检查硬件连接
- 确认波特率设置为1Mbps
- 检查终端电阻（120Ω）

#### 2. 电机无响应
- 检查电源连接
- 确认电机ID设置正确
- 检查使能命令是否发送

#### 3. 数据读取异常
- 增加接收超时时间
- 检查CAN总线干扰
- 验证数据解析逻辑

#### 4. 编译错误
- 确认ESP32开发板安装正确
- 检查库文件版本兼容性
- 验证Arduino IDE版本

### 调试方法

#### 1. 串口调试
- 打开串口监视器观察初始化过程
- 检查实时数据输出
- 使用串口命令测试功能

#### 2. CAN总线监控
```
# 如果有CAN分析工具，监控总线流量
# 检查发送和接收的CAN帧
```

#### 3. 逐步测试
```cpp
// 简化测试代码，只测试基本功能
void simple_test() {
    Motor_CAN_Init();
    M1_con.Motor_Con_Init(1);
    M1_con.Motor_Enable();
    delay(1000);
    M1_con.Set_SpeedMode(1.0);
}
```

## 📈 扩展功能

### 可添加的功能
1. **多电机控制**：支持同时控制多个电机
2. **轨迹规划**：实现复杂的运动轨迹
3. **PID参数整定**：自动优化控制参数
4. **Web界面**：通过WiFi远程控制
5. **数据记录**：SD卡存储运行数据
6. **故障诊断**：自动故障检测和处理

### 性能优化
1. **实时性**：使用FreeRTOS提高实时性能
2. **通信效率**：优化CAN总线使用率
3. **控制精度**：改进控制算法精度
4. **功耗管理**：优化系统功耗

## 📞 技术支持

如有问题，请检查：
1. 硬件连接是否正确
2. 参数配置是否合理
3. 电源供应是否稳定
4. 串口输出的错误信息

## 📄 许可证

本项目基于小米电机通信协议开发，仅供学习和研究使用。

---

**版本信息：**
- 版本：v1.0
- 更新日期：2024年
- 兼容性：ESP32S3 + 小米电机
- 开发环境：Arduino IDE