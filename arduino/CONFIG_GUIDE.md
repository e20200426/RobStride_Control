# 🔧 电机ID配置功能使用指南

## 🎯 功能概述

`simple_joint_control` 现在支持**动态电机ID配置**，无需重新编译程序即可控制不同ID的电机！

## 🚀 快速使用

### 1. 查看当前配置
```bash
config
```
**输出示例：**
```
=== 当前配置 ===
电机ID: 1
主机ID: 0
最大速度: 2.0 rad/s
位置控制KP: 20.0
==================
```

### 2. 更改电机ID
```bash
id 2
```
**输出示例：**
```
电机ID已设置为: 2
请输入 'restart' 重启电机以应用新ID
```

### 3. 重启电机应用新ID
```bash
restart
```

### 4. 测试新ID电机
```bash
90      # 测试电机2是否响应
```

## 📋 完整配置流程

### 场景1：首次使用电机ID=2
```bash
# 1. 查看当前配置
config          # 确认当前是ID=1

# 2. 设置新ID
id 2            # 设置为电机ID=2

# 3. 确认设置
config          # 确认ID已改为2

# 4. 重启电机
restart         # 应用新配置

# 5. 测试控制
90              # 电机2应该转到90度
0               # 电机2应该回到0度
```

### 场景2：切换不同电机
```bash
# 当前控制电机3，想切换到电机5
config          # 查看：当前ID=3
id 5            # 设置为ID=5
restart         # 重启电机
180             # 测试电机5
```

### 场景3：恢复默认设置
```bash
# 恢复到默认电机ID=1
id 1            # 设置为ID=1
restart         # 重启电机
```

## 💾 配置保存机制

### 自动保存
- ✅ 配置更改后**自动保存**到ESP32的EEPROM
- ✅ **断电不丢失**，重启后自动加载保存的配置
- ✅ 首次运行自动使用默认配置（ID=1）

### 配置内容
```cpp
struct MotorConfig {
  uint8_t motor_id;        // 电机ID (1-127)
  uint8_t master_id;       // 主机ID (固定为0)
  float max_speed;         // 最大速度 (2.0 rad/s)
  float position_kp;       // 位置控制KP (20.0)
  bool initialized;        // 初始化标志
};
```

## 🔧 技术细节

### ID范围限制
- **电机ID**: 1-127（小米电机标准范围）
- **主机ID**: 0（固定，小米协议规定）
- **自动验证**: 输入超出范围会拒绝设置

### 配置验证
```bash
# 测试无效ID
id 0            # ❌ 错误：电机ID范围应为1-127
id 128          # ❌ 错误：电机ID范围应为1-127
id 5            # ✅ 成功：在有效范围内
```

### 实时反馈
- 状态显示中会显示当前控制的电机ID
```bash
电机2: 位置 1.571 rad (90.0°), 速度: 0.15 rad/s
      ↑
   当前电机ID
```

## 🎪 实际应用场景

### 1. 机器人多关节控制
```bash
# 控制关节1（电机ID=1）
id 1
restart
0     # 回到起始位置
90    # 转到90度

# 控制关节2（电机ID=2）
id 2
restart
0     # 回到起始位置
45    # 转到45度

# 控制关节3（电机ID=3）
id 3
restart
0     # 回到起始位置
180   # 转到180度
```

### 2. 多设备测试
```bash
# 测试电机1
id 1 && restart && 90

# 测试电机2
id 2 && restart && 90

# 测试电机3
id 3 && restart && 90
```

### 3. 设备维护
```bash
# 维修时快速切换测试电机
config          # 查看当前配置
id 10           # 切换到测试电机
restart         # 应用配置
90              # 测试功能
```

## 🛡️ 安全特性

### 配置保护
- ✅ **自动验证**：检查配置有效性
- ✅ **备份机制**：首次运行自动创建默认配置
- ✅ **错误恢复**：配置损坏时自动使用默认值

### 使用安全
- ✅ **即时反馈**：所有操作都有明确的成功/失败反馈
- ✅ **确认机制**：更改ID后需要重启才生效，避免误操作
- ✅ **状态显示**：实时显示当前控制的电机ID

## 🔍 故障排除

### 问题1：配置更改无效
```bash
# 症状：id 2 后电机还是按ID=1响应
# 解决：必须输入restart重启电机
id 2
restart
```

### 问题2：配置丢失
```bash
# 症状：重启后配置回到默认
# 解决：重新设置，EEPROM会自动保存
id 2
restart
```

### 问题3：无效ID被接受
```bash
# 痋状：id 0 或 id 128 被接受
# 解决：程序会自动拒绝，显示错误信息
❌ 电机ID范围应为1-127
```

### 问题4：EEPROM错误
```bash
# 症状：首次运行显示配置错误
# 解决：程序会自动使用默认配置并保存
首次运行或配置无效，使用默认配置
```

## 💡 最佳实践

### 1. 定期检查配置
```bash
# 在重要操作前检查配置
config
```

### 2. 谨试更改ID
```bash
# 更改ID后立即重启测试
id X
restart
90      # 测试新ID电机是否响应
```

### 3. 记录电机分配
```
电机ID分配表：
ID=1 : 左臂关节
ID=2 : 右臂关节
ID=3 : 头部关节
...
```

### 4. 备份重要配置
```bash
# 记录当前配置信息
电机ID: 1
最大速度: 2.0
位置KP: 20.0
```

## 🎯 高级用法

### 批量控制脚本
```bash
# 可以编写脚本顺序控制多个电机
# pseudo code
for motor_id in [1, 2, 3]:
  send "id " + motor_id
  send "restart"
  send "90"
  wait 3000
  send "0"
  wait 2000
```

### 配置预设
```bash
# 高速配置（用于测试）
id 1 && restart && speed 5.0

# 精密配置（用于精密控制）
id 1 && restart && speed 1.0
```

---

**总结**：现在您可以轻松控制不同ID的电机，无需重新编译程序！配置会自动保存，使用非常方便。

**文件位置**：`/mi_arduino/simple_joint_control/simple_joint_control.ino`