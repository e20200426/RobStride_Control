# 电机ID设置程序

**通过CAN总线动态修改小米电机ID，实现多电机串联控制**

## 🎯 功能特点

- ✅ **扫描电机**：自动发现总线上所有电机
- ✅ **ID修改**：通过CAN总线修改电机ID
- ✅ **批量设置**：快速设置连续电机ID
- ✅ **验证功能**：确认ID修改结果
- ✅ **安全检查**：防止ID冲突和错误

## 📱 串口命令

### 基础命令
```bash
help                   # 显示帮助信息
scan                   # 扫描总线上的电机(1-127)
scan 1 20              # 扫描指定范围的电机ID
verify                 # 验证发现的电机ID
```

### ID设置命令 ⚠️ **（总线上只能连接一个电机）**
```bash
set 1 2               # 将ID=1的电机改为ID=2
set 5 10              # 将ID=5的电机改为ID=10
reset 3               # 重置指定电机
```

### 批量设置命令
```bash
batch 5               # 批量设置：1→5, 2→6, 3→7, 4→8, 5→9...
```

## 🚀 使用流程

### 方案一：单个电机逐步设置
```bash
# 1. 连接第一个电机到总线
scan                    # 查看当前电机ID
set 1 2                 # 将ID=1改为ID=2
verify                  # 确认修改成功

# 2. 断开第一个电机，连接第二个电机
scan                    # 查看第二个电机ID
set 1 3                 # 将ID=1改为ID=3
verify                  # 确认修改成功

# 3. 重复步骤，直到所有电机都设置了唯一ID
```

### 方案二：批量快速设置（推荐）
```bash
batch 5                 # 开始批量设置，从ID=5开始
# 程序会提示：
# - 连接电机1，按任意键继续
# - 设置电机1为ID=5
# - 连接电机2，按任意键继续
# - 设置电机2为ID=6
# ... 继续直到所有电机设置完成

verify                  # 验证所有电机ID设置
```

### 方案三：精确控制设置
```bash
# 预先规划电机ID分配：
# 电机1 → ID=1 (关节1)
# 电机2 → ID=2 (关节2)
# 电机3 → ID=3 (关节3)

# 依次设置：
scan 1 10              # 扫描1-10范围内的电机
set 7 1                # 将发现的电机改为ID=1
# (断开电机1，连接电机2)
set 7 2                # 将发现的电机改为ID=2
# ... 继续设置所有电机

verify                  # 最终验证
```

## 🔧 工作原理

### SET_MOTOR_CAN_ID协议
- **命令模式**: 7 (SET_MOTOR_CAN_ID)
- **数据格式**: 第一个字节为新的电机ID
- **仲裁ID**: (7<<24) | (MASTER_ID<<8) | OLD_MOTOR_ID
- **响应验证**: 修改后用新ID ping 电机

### ID修改过程
1. 发送SET_MOTOR_CAN_ID命令
2. 电机内部修改保存新的CAN ID
3. 电机重启或重新初始化
4. 使用新ID验证修改成功

## 📊 实际应用场景

### 1. 机器人多关节控制
```bash
# 6自由度机械臂
batch 6                 # 设置6个电机：ID=1,2,3,4,5,6
# 对应关系：
# ID=1 → 基座关节
# ID=2 → 肩部关节
# ID=3 → 肘部关节
# ID=4 → 腕部关节
# ID=5 → 手腕关节
# ID=6 → 手爪关节
```

### 2. 多轮驱动控制
```bash
# 4轮驱动小车
set 1 1                # 前左轮 (保持ID=1)
set 1 2                # 前右轮 (改为ID=2)
set 1 3                # 后左轮 (改为ID=3)
set 1 4                # 后右轮 (改为ID=4)
```

### 3. 云台控制系统
```bash
# 2轴云台
set 1 10               # 水平轴改为ID=10
set 1 11               # 垂直轴改为ID=11
# 避免与底盘电机ID冲突
```

## ⚠️ 重要注意事项

### 安全操作
1. **修改ID时只连接一个电机**：避免多个电机同时响应造成混乱
2. **记录电机对应关系**：建议记录哪个物理电机对应哪个ID
3. **备份原始ID**：某些电机的原始ID可能有特殊用途
4. **电源稳定**：ID修改过程中不要断电

### ID分配原则
1. **连续分配**：1,2,3,4... 便于管理
2. **功能分组**：关节电机用连续ID，轮子电机用另一组连续ID
3. **预留空间**：为后续扩展预留ID空间

### 故障排除
```bash
# 修改失败？
reset <id>              # 先重置电机
set <old> <new>          # 重新尝试修改
verify                  # 确认结果

# 扫描不到电机？
- 检查CAN连接
- 检查电机电源
- 确认波特率1Mbps
- 检查终端电阻

# ID冲突？
scan 1 127              # 扫描所有ID
- 找出冲突的ID
- 重新分配唯一ID
```

## 🎪 完整示例

### 示例1：3关节机械臂设置
```bash
# 步骤1：连接第一个电机
scan
# 输出：发现电机ID: 1
set 1 1
# 输出：成功！电机ID已修改为: 1

# 步骤2：连接第二个电机
scan
# 输出：发现电机ID: 1
set 1 2
# 输出：成功！电机ID已修改为: 2

# 步骤3：连接第三个电机
scan
# 输出：发现电机ID: 1
set 1 3
# 输出：成功！电机ID已修改为: 3

# 步骤4：验证所有电机
verify
# 输出：发现 3 个电机，当前电机ID: 1, 2, 3
```

### 示例2：快速批量设置5个电机
```bash
batch 1
# 程序提示：连接第1个电机，按任意键...
# 用户按键，程序自动设置为ID=1

# 程序提示：连接第2个电机，按任意键...
# 用户按键，程序自动设置为ID=2

# ... 继续设置第3、4、5个电机

# 最终输出：批量设置完成！5个电机ID为: 1,2,3,4,5
```

## 🔧 技术细节

### CAN帧格式
```
仲裁ID: (7<<24) | (0<<8) | old_motor_id
数据: [new_motor_id, 0, 0, 0, 0, 0, 0, 0]
```

### 支持的ID范围
- **电机ID**: 1-127 (小米电机标准)
- **主机ID**: 0 (固定，小米协议)
- **最大电机数**: 127个

### 通信参数
- **波特率**: 1Mbps
- **帧格式**: 扩展帧
- **数据长度**: 8字节

## 💡 高级技巧

### 1. ID规划模板
```bash
# 机器人系统规划：
# ID 1-10:   关节电机
# ID 11-20:  轮子电机
# ID 21-30:  执行器电机
# ID 31-50:  传感器预留
# ID 51-127: 备用
```

### 2. 快速验证脚本
```bash
# 验证前10个电机
verify

# 验证特定电机
scan 10 15
# 只扫描ID 10-15
```

### 3. 故障恢复
```bash
# 如果某个电机无响应
reset <problem_id>
# 重置电机

# 如果ID冲突
scan 1 127
# 全面扫描找出所有电机
```

## 📋 适用场景

- 🤖 **多关节机器人控制**：每个关节独立ID
- 🚗 **多轮驱动系统**：左右轮独立控制
- 📷 **云台系统**：水平和垂直轴独立ID
- 🔧 **生产线设备**：多个执行器协调控制
- 🎮 **游戏设备**：多个电机同时控制

---

**总结**：通过这个程序，您可以轻松管理多个小米电机的ID，实现复杂的电机控制系统。建议使用批量设置功能来快速配置多个电机。